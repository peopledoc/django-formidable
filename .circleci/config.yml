version: 2
jobs:
  build:
    docker:
      - image: themattrix/tox
      - image: cimg/postgres:15.3
        environment:
          POSTGRES_HOST_AUTH_METHOD: trust
    working_directory: ~/django-formidable
    steps:
      - run:
          name: "Update APT stuff"
          command: "apt-get update"
      - run:
          name: "Install postgresql-common Debian package"
          command: "apt-get install -y postgresql postgresql-common"
      - checkout
      - run:
          name: Run the test suite
          command: |
            chmod 777 /tmp
            tox -r

  docs:
    working_directory: ~/django-formidable
    docker:
      - image: cimg/node:lts-buster
    steps:
      - checkout
      - run:
          name: Check Python version & install Python dependencies
          command: |
            python3 --version
            sudo apt update && sudo apt install python3-pip python3-dev
      - run:
          name: Run Sphinx doc tests using tox
          command: |
            python3 -m pip install --user tox
            ~/.local/bin/tox -e docs

workflows:
  version: 2
  tests:
    jobs:
      # Run Python / Django tests
      - build
      # Build docs (requires npm/node)
      - docs
